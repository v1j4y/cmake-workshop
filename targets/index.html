<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Target-based build systems with CMake &mdash; CMake Workshop  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" type="text/css" />
      <link rel="stylesheet" href="../_static/style.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/coderefinery.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script src="../_static/tabs.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Detecting your environment" href="../environment/" />
    <link rel="prev" title="Compile flags, definitions, and debugging" href="../flags-definitions-debugging/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../" class="icon icon-home"> CMake Workshop
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Setting up your system</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../motivation/">Motivation and overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tour/">Brief tour to demonstrate concepts/capabilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hands-on workshop</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hello-cmake/">From sources to executables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flags-definitions-debugging/">Compile flags, definitions, and debugging</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Target-based build systems with CMake</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">Targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#properties">Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visibility-levels">Visibility levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-a-larger-project-with-multiple-folders">Building a larger project with multiple folders</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../environment/">Detecting your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies/">Finding and using dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/">Creating and running tests with CTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fetch-content/">Automated dependency handling with FetchContent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../growing-projects/">Growing projects: pitfalls and recommendations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../resources/">Resources and books</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits/">Credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">CMake Workshop</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home"></a> &raquo;</li>
      <li>Target-based build systems with CMake</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/coderefinery/cmake-workshop/blob/main/content/targets.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="target-based-build-systems-with-cmake">
<span id="targets"></span><h1>Target-based build systems with CMake<a class="headerlink" href="#target-based-build-systems-with-cmake" title="Permalink to this headline"></a></h1>
<div class="admonition-objectives objectives admonition">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Learn that the basic elements in CMake are <em>not</em> variables, <em>but</em> targets.</p></li>
<li><p>Learn about properties of targets and how to use them.</p></li>
<li><p>Learn how to use <em>visibility levels</em> to express dependencies between targets.</p></li>
<li><p>Learn how to work with projects spanning multiple folders.</p></li>
<li><p>Learn how to handle multiple targets in one project.</p></li>
</ul>
</div>
<p>Real-world projects require more than compiling a few source files into
executables and/or libraries.  In the vast majority of cases, you will be faced
with projects comprising dozens to hundreds of source files sprawling in a complex source
tree.  Using modern CMake helps you keep the complexity of the build system in
check.</p>
<p>With the advent of CMake 3.0, there has been a
significant shift in the way the CMake domain-specific language (DSL) is
structured.  Rather than relying on global scope <strong>variables</strong> to convey
information in a project, we should shift to using <strong>targets</strong> and
<strong>properties</strong>.</p>
<p>We will first demonstrate the better, nicer way using targets and properties,
but we will also contrast this approach with less nice solutions that many
codes use (global variables and less abstraction), so that we learn recognizing
good patterns and stay away from less maintainable patterns for our own
projects.</p>
<div class="section" id="id1">
<h2>Targets<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h2>
<p>A target is declared by either <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/add_executable.html"><span class="xref std std-term"><code class="docutils literal notranslate">add_executable</code></span></a> or <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/add_library.html"><span class="xref std std-term"><code class="docutils literal notranslate">add_library</code></span></a>: thus, in broad
terms, a target maps to a build artifact in the project.</p>
<p>You can add custom targets to the build system with <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/add_custom_target.html"><span class="xref std std-term"><code class="docutils literal notranslate">add_custom_target</code></span></a>.
Custom targets are not necessarily build artifacts.</p>
<p>Any target has a collection of <strong>properties</strong>, which define <em>how</em> the build
artifact should be produced <strong>and</strong> <em>how</em> it should be used by other dependent
targets in the project.</p>
<div class="figure align-center" id="id2">
<img alt="../_images/target.svg" src="../_images/target.svg" /><p class="caption"><span class="caption-text">A target is the basic element in the CMake DSL. Each target has <em>properties</em>,
which can be read with <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/get_target_property.html"><span class="xref std std-term"><code class="docutils literal notranslate">get_target_property</code></span></a> and modified with
<a class="reference internal" href="https://cmake.org/cmake/help/latest/command/set_target_properties.html"><span class="xref std std-term"><code class="docutils literal notranslate">set_target_properties</code></span></a>.  Compile options, definitions, include directories,
source files, link libraries, and link options are properties of targets.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</div>
<p>The five most used commands used to handle targets are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_sources.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_sources</code></span></a></p></li>
<li><p><a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_compile_options.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_compile_options</code></span></a></p></li>
<li><p><a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_compile_definitions.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_compile_definitions</code></span></a></p></li>
<li><p><a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_include_directories.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_include_directories</code></span></a></p></li>
<li><p><a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_link_libraries.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_link_libraries</code></span></a></p></li>
</ul>
<p>There are additional commands in the <code class="docutils literal notranslate"><span class="pre">target_*</span></code> family:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cmake --help-command-list <span class="p">|</span> grep <span class="s2">&quot;^target_&quot;</span>

<span class="go">target_compile_definitions</span>
<span class="go">target_compile_features</span>
<span class="go">target_compile_options</span>
<span class="go">target_include_directories</span>
<span class="go">target_link_directories</span>
<span class="go">target_link_libraries</span>
<span class="go">target_link_options</span>
<span class="go">target_precompile_headers</span>
<span class="go">target_sources</span>
</pre></div>
</div>
</div>
<div class="section" id="properties">
<h2>Properties<a class="headerlink" href="#properties" title="Permalink to this headline"></a></h2>
<p>CMake lets you set properties at many different levels of visibility across the
project:</p>
<ul class="simple">
<li><p><strong>Global scope</strong>. These are equivalent to variables set in the root
<code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>. Their use is, however, more powerful as they can be set
from <em>any</em> leaf <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>.</p></li>
<li><p><strong>Directory scope</strong>. These are equivalent to variables set in a given leaf <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>.</p></li>
<li><p><strong>Target</strong>. These are the properties set on targets that we discussed above.</p></li>
<li><p><strong>Test</strong>.</p></li>
<li><p><strong>Source files</strong>. For example, compiler flags.</p></li>
<li><p><strong>Cache entries</strong>.</p></li>
<li><p><strong>Installed files</strong>.</p></li>
</ul>
<p>For a complete list of properties known to CMake:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cmake --help-properties <span class="p">|</span> less
</pre></div>
</div>
<p>You can get the current value of any property with <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/get_property.html"><span class="xref std std-term"><code class="docutils literal notranslate">get_property</code></span></a>
and set the value of any property with <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/set_property.html"><span class="xref std std-term"><code class="docutils literal notranslate">set_property</code></span></a>.</p>
</div>
<div class="section" id="visibility-levels">
<h2>Visibility levels<a class="headerlink" href="#visibility-levels" title="Permalink to this headline"></a></h2>
<p>It is much more robust to use targets and properties than using variables and
here we will discuss why.</p>
<div class="figure align-center" id="id3">
<img alt="../_images/target_inheritance.svg" src="../_images/target_inheritance.svg" /><p class="caption"><span class="caption-text">Properties on targets have <strong>visibility levels</strong>, which determine how CMake
should propagate them between interdependent targets.</span><a class="headerlink" href="#id3" title="Permalink to this image"></a></p>
</div>
<p>Visibility levels <code class="docutils literal notranslate"><span class="pre">PRIVATE</span></code>, <code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code>, or <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> are very powerful
but not easy to describe and imagine in words. Maybe a better approach to
demonstrate what visibility levels is to see it in action.</p>
<p>We will demonstrate this with a hello world example where somebody went a bit
too far with modularity and where we have split the code into 3 libraries and
the main function (<code class="docutils literal notranslate"><span class="pre">content/examples/property-visibility/</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── CMakeLists.txt
├── greeting
│   ├── greeting.cpp
│   └── greeting.hpp
├── hello_world
│   ├── hello_world.cpp
│   └── hello_world.hpp
├── main.cpp
└── world
    ├── world.cpp
    └── world.hpp
</pre></div>
</div>
<p>Here the main function links to greeting which links to hello_world which links to world.</p>
<div class="admonition-the-internal-dependency-tree callout admonition">
<p class="admonition-title">The internal dependency tree</p>
<p>If you have Graphviz installed, you can visualize the dependencies between
the targets:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> build
<span class="gp">$ </span>cmake --graphviz<span class="o">=</span>project.dot ..
<span class="gp">$ </span>dot -T svg project.dot -o project.svg
</pre></div>
</div>
<div class="figure align-center" id="id4">
<img alt="../_images/project.svg" src="../_images/project.svg" /><p class="caption"><span class="caption-text">The dependencies between the four targets in the example project.</span><a class="headerlink" href="#id4" title="Permalink to this image"></a></p>
</div>
</div>
<p>This is the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> - take some time to study it since there is a quite a lot going on:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.14</span><span class="p">)</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="nb">project</span><span class="p">(</span><span class="s">example</span> <span class="s">LANGUAGES</span> <span class="s">CXX</span><span class="p">)</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="nb">add_library</span><span class="p">(</span><span class="s">world</span><span class="p">)</span>
<span class="linenos"> 7</span><span class="nb">target_sources</span><span class="p">(</span><span class="s">world</span>
<span class="linenos"> 8</span>  <span class="s">PUBLIC</span>
<span class="linenos"> 9</span>    <span class="s">world/world.hpp</span>
<span class="linenos">10</span>  <span class="s">PRIVATE</span>
<span class="linenos">11</span>    <span class="s">world/world.cpp</span>
<span class="linenos">12</span>  <span class="p">)</span>
<span class="linenos">13</span><span class="nb">target_include_directories</span><span class="p">(</span><span class="s">world</span>
<span class="linenos">14</span>  <span class="s">PUBLIC</span>
<span class="linenos">15</span>    <span class="s">world</span>
<span class="linenos">16</span>  <span class="p">)</span>
<span class="hll"><span class="linenos">17</span><span class="c"># target_compile_definitions(world PRIVATE &quot;MY_DEFINITION&quot;)</span>
</span><span class="linenos">18</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="nb">add_library</span><span class="p">(</span><span class="s">hello_world</span><span class="p">)</span>
<span class="linenos">21</span><span class="nb">target_sources</span><span class="p">(</span><span class="s">hello_world</span>
<span class="linenos">22</span>  <span class="s">PUBLIC</span>
<span class="linenos">23</span>    <span class="s">hello_world/hello_world.hpp</span>
<span class="linenos">24</span>  <span class="s">PRIVATE</span>
<span class="linenos">25</span>    <span class="s">hello_world/hello_world.cpp</span>
<span class="linenos">26</span>  <span class="p">)</span>
<span class="linenos">27</span><span class="nb">target_include_directories</span><span class="p">(</span><span class="s">hello_world</span>
<span class="linenos">28</span>  <span class="s">PUBLIC</span>
<span class="linenos">29</span>    <span class="s">hello_world</span>
<span class="linenos">30</span>  <span class="p">)</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="c"># hello_world depends on world</span>
<span class="linenos">33</span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">hello_world</span> <span class="s">PRIVATE</span> <span class="s">world</span><span class="p">)</span>
<span class="linenos">34</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="nb">add_library</span><span class="p">(</span><span class="s">greeting</span><span class="p">)</span>
<span class="linenos">37</span><span class="nb">target_sources</span><span class="p">(</span><span class="s">greeting</span>
<span class="linenos">38</span>  <span class="s">PUBLIC</span>
<span class="linenos">39</span>    <span class="s">greeting/greeting.hpp</span>
<span class="linenos">40</span>  <span class="s">PRIVATE</span>
<span class="linenos">41</span>    <span class="s">greeting/greeting.cpp</span>
<span class="linenos">42</span>  <span class="p">)</span>
<span class="linenos">43</span><span class="nb">target_include_directories</span><span class="p">(</span><span class="s">greeting</span>
<span class="linenos">44</span>  <span class="s">PUBLIC</span>
<span class="linenos">45</span>    <span class="s">greeting</span>
<span class="linenos">46</span>  <span class="p">)</span>
<span class="linenos">47</span>
<span class="linenos">48</span><span class="c"># greeting depends on hello_world</span>
<span class="linenos">49</span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">greeting</span> <span class="s">PRIVATE</span> <span class="s">hello_world</span><span class="p">)</span>
<span class="linenos">50</span>
<span class="linenos">51</span>
<span class="linenos">52</span><span class="nb">add_executable</span><span class="p">(</span><span class="s">example</span> <span class="s">main.cpp</span><span class="p">)</span>
<span class="linenos">53</span>
<span class="linenos">54</span><span class="c"># example depends on greeting</span>
<span class="linenos">55</span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">example</span> <span class="s">PRIVATE</span> <span class="s">greeting</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition-testing-the-3-different-visibility-levels exercise important admonition">
<p class="admonition-title">Testing the 3 different visibility levels</p>
<ol class="arabic">
<li><p>Browse, configure, build, and run the code.</p></li>
<li><p>Now uncomment the highlighted line (line 17) with <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_compile_definitions.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_compile_definitions</code></span></a>, configure into a fresh folder, and build:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cmake -S. -Bbuild_private
<span class="gp">$ </span>cmake --build build_private
</pre></div>
</div>
<p>You will see that the definition is used in <code class="docutils literal notranslate"><span class="pre">world.cpp</span></code> but nowhere else.</p>
</li>
<li><p>Now change the definition to <code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code>, configure into a fresh folder, and build.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cmake -S. -Bbuild_public
<span class="gp">$ </span>cmake --build build_public
</pre></div>
</div>
<p>You will see that the definition is used both in <code class="docutils literal notranslate"><span class="pre">world.cpp</span></code> and <code class="docutils literal notranslate"><span class="pre">hello_world.cpp</span></code>.</p>
</li>
<li><p>Now change the definition to <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code>, configure into a fresh folder, and build.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cmake -S. -Bbuild_interface
<span class="gp">$ </span>cmake --build build_interface
</pre></div>
</div>
<p>You will see that the definition is used only in <code class="docutils literal notranslate"><span class="pre">hello_world.cpp</span></code> but not in <code class="docutils literal notranslate"><span class="pre">world.cpp</span></code>.</p>
</li>
</ol>
</div>
<div class="admonition-visibility-levels discussion attention admonition">
<p class="admonition-title">Visibility levels</p>
<p>Discuss what this means and how we can use it to fine-tune visibility of
definitions, include directories, and libraries.</p>
<p>What do you think will happen if we change the visibility in line 14 of the
above code to <code class="docutils literal notranslate"><span class="pre">PRIVATE</span></code>?</p>
</div>
</div>
<div class="section" id="building-a-larger-project-with-multiple-folders">
<span id="multiple-folders"></span><h2>Building a larger project with multiple folders<a class="headerlink" href="#building-a-larger-project-with-multiple-folders" title="Permalink to this headline"></a></h2>
<p>In the example above we have split a project into folders and libraries but we
kept one <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>. As the project grows, this becomes impractical for
humans (the CMake computer overlords will not mind) and maintenance becomes
easier if we split the CMake configuration into multiple <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>
with the help of <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/add_subdirectory.html"><span class="xref std std-term"><code class="docutils literal notranslate">add_subdirectory</code></span></a>. Our goal is to have a <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> as
close as possible to the source files.</p>
<p>We will soon practice with an example project where instead of this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>project/
├── CMakeLists.txt           &lt;--- Only at root
├── external
└── src
    ├── evolution
    ├── initial
    ├── io
    └── parser
</pre></div>
</div>
<p>we rather wish this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>project/
├── CMakeLists.txt           &lt;--- Root
├── external
│   ├── CMakeLists.txt       &lt;--- Leaf
└── src
    ├── CMakeLists.txt       &lt;--- Another leaf
    ├── evolution
    │   ├── CMakeLists.txt   &lt;--- Leaf of leaf
    ├── initial
    │   ├── CMakeLists.txt   &lt;--- Leaf of leaf
    ├── io
    │   ├── CMakeLists.txt   &lt;--- Leaf of leaf
    └── parser
        └── CMakeLists.txt   &lt;--- Leaf of leaf
</pre></div>
</div>
<p>Each folder in a multi-folder project will contain a <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>: a
source tree with one <strong>root</strong> and many <strong>leaves</strong>.</p>
<p>The root <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> will contain the invocation of the <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/project.html"><span class="xref std std-term"><code class="docutils literal notranslate">project</code></span></a>
command: variables and targets declared in the root have effectively global
scope. Remember also that <a class="reference internal" href="https://cmake.org/cmake/help/latest/variable/PROJECT_SOURCE_DIR.html"><span class="xref std std-term"><code class="docutils literal notranslate">PROJECT_SOURCE_DIR</code></span></a> will point to the folder
containing the root <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>.
In order to move between the root and a leaf or between leaves, you will use the
<a class="reference internal" href="https://cmake.org/cmake/help/latest/command/add_subdirectory.html"><span class="xref std std-term"><code class="docutils literal notranslate">add_subdirectory</code></span></a> command.</p>
<p>We can declare targets at any level, not necessarily the root: a target is
visible at the level at which it is declared and all higher levels.</p>
<div class="admonition-exercise-practicing-structuring-projects-with-cellular-automata exercise important admonition">
<p class="admonition-title">Exercise: practicing structuring projects with cellular automata</p>
<p>Let’s move beyond “Hello, world” and work with a project spanning multiple
folders. We will implement a relatively simple code to compute and print to
screen elementary <a class="reference external" href="https://en.wikipedia.org/wiki/Cellular_automaton#Elementary_cellular_automata">cellular automata</a>.
We separate the sources into <code class="docutils literal notranslate"><span class="pre">src</span></code> and <code class="docutils literal notranslate"><span class="pre">external</span></code> to simulate a nested project
which reuses an external project.
Your goal is to:</p>
<ol class="arabic simple">
<li><p>Build the main executable at <code class="docutils literal notranslate"><span class="pre">content/examples/multiple-folders/problem/</span></code>.</p></li>
<li><p>Where is it located in the build tree? Remember
that CMake generates a build tree mirroring the source tree.</p></li>
<li><p>The executable will accept 3 arguments: the length, number of steps, and
automaton rule.  You can run it with:</p></li>
</ol>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>automata <span class="m">40</span> <span class="m">5</span> <span class="m">30</span>
</pre></div>
</div>
<p>This is the output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>length: 40
number of steps: 5
rule: 30
                    *
                   ***
                  **  *
                 ** ****
                **  *   *
               ** **** ***
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>Push the definition of targets “down” into folders and subfolders, as close
as possible to the source files with the help of <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/add_subdirectory.html"><span class="xref std std-term"><code class="docutils literal notranslate">add_subdirectory</code></span></a>.</p></li>
</ol>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Fortran</button><button aria-controls="panel-0-0-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-2" name="0-2" role="tab" tabindex="-1">Bonus</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>You want to arrive at this (<code class="docutils literal notranslate"><span class="pre">content/examples/multiple-folders/solution/cxx/</span></code>) structure:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>.
├── CMakeLists.txt
├── external
│   ├── CMakeLists.txt
│   ├── conversion.cpp
│   └── conversion.hpp
└── src
    ├── CMakeLists.txt
    ├── evolution
    │   ├── CMakeLists.txt
    │   ├── evolution.cpp
    │   └── evolution.hpp
    ├── initial
    │   ├── CMakeLists.txt
    │   ├── initial.cpp
    │   └── initial.hpp
    ├── io
    │   ├── CMakeLists.txt
    │   ├── io.cpp
    │   └── io.hpp
    ├── main.cpp
    └── parser
        ├── CMakeLists.txt
        ├── parser.cpp
        └── parser.hpp
</pre></div>
</div>
<p>In <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/target_sources.html"><span class="xref std std-term"><code class="docutils literal notranslate">target_sources</code></span></a>, does using absolute
(<code class="docutils literal notranslate"><span class="pre">${CMAKE_CURRENT_LIST_DIR}/parser.cpp</span></code>) or relative
(<code class="docutils literal notranslate"><span class="pre">parser.cpp</span></code>) paths make any difference?</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>You want to arrive at this (<code class="docutils literal notranslate"><span class="pre">content/examples/multiple-folders/solution/fortran/</span></code>) structure:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>.
├── CMakeLists.txt
├── external
│   ├── CMakeLists.txt
│   └── conversion.f90
└── src
    ├── CMakeLists.txt
    ├── evolution
    │   ├── ancestors.f90
    │   ├── CMakeLists.txt
    │   ├── empty.f90
    │   └── evolution.f90
    ├── initial
    │   ├── CMakeLists.txt
    │   └── initial.f90
    ├── io
    │   ├── CMakeLists.txt
    │   └── io.f90
    ├── main.f90
    └── parser
        ├── CMakeLists.txt
        └── parser.f90
</pre></div>
</div>
<p>Note that CMake can understand the compilation order imposed by the
Fortran modules without further intervention. Where are the <code class="docutils literal notranslate"><span class="pre">.mod</span></code>
files?</p>
</div><div aria-labelledby="tab-0-0-2" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-2" name="0-2" role="tabpanel" tabindex="0"><p>You can decide where executables, static and shared libraries, and
Fortran <code class="docutils literal notranslate"><span class="pre">.mod</span></code> files will be stored within the build tree.
The relevant variables are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span></code>, for executables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CMAKE_ARCHIVE_OUTPUT_DIRECTORY</span></code>, for static libraries.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CMAKE_LIBRARY_OUTPUT_DIRECTORY</span></code>, for shared libraries.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CMAKE_Fortran_MODULE_DIRECTORY</span></code>, for Fortran <code class="docutils literal notranslate"><span class="pre">.mod</span></code> files.</p></li>
</ul>
<p>Modify your <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> to output the <code class="docutils literal notranslate"><span class="pre">automata</span></code> executable in
<code class="docutils literal notranslate"><span class="pre">build/bin</span></code> and the libraries in <code class="docutils literal notranslate"><span class="pre">build/lib</span></code>.</p>
</div></div>
<ol class="arabic simple" start="5">
<li><p>Discuss pros and cons of one <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> compared to many.</p></li>
</ol>
</div>
<div class="admonition-target-properties-vs-global-settings discussion attention admonition">
<p class="admonition-title">Target properties vs. global settings</p>
<p>Let us return to the very granular hello world example from futher above.
In CMake there are many ways to achieve something and here we compare two.</p>
<p>Please discuss pros and cons and what possible problems you see or
anticipate.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">OK example</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">Bad example</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>This is the example we have used further above. It is not perfect
but much better than the example in the other tab.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.14</span><span class="p">)</span>

<span class="nb">project</span><span class="p">(</span><span class="s">example</span> <span class="s">LANGUAGES</span> <span class="s">CXX</span><span class="p">)</span>


<span class="nb">add_library</span><span class="p">(</span><span class="s">world</span><span class="p">)</span>
<span class="nb">target_sources</span><span class="p">(</span><span class="s">world</span>
  <span class="s">PUBLIC</span>
    <span class="s">world/world.hpp</span>
  <span class="s">PRIVATE</span>
    <span class="s">world/world.cpp</span>
  <span class="p">)</span>
<span class="nb">target_include_directories</span><span class="p">(</span><span class="s">world</span>
  <span class="s">PUBLIC</span>
    <span class="s">world</span>
  <span class="p">)</span>
<span class="c"># target_compile_definitions(world PRIVATE &quot;MY_DEFINITION&quot;)</span>


<span class="nb">add_library</span><span class="p">(</span><span class="s">hello_world</span><span class="p">)</span>
<span class="nb">target_sources</span><span class="p">(</span><span class="s">hello_world</span>
  <span class="s">PUBLIC</span>
    <span class="s">hello_world/hello_world.hpp</span>
  <span class="s">PRIVATE</span>
    <span class="s">hello_world/hello_world.cpp</span>
  <span class="p">)</span>
<span class="nb">target_include_directories</span><span class="p">(</span><span class="s">hello_world</span>
  <span class="s">PUBLIC</span>
    <span class="s">hello_world</span>
  <span class="p">)</span>

<span class="c"># hello_world depends on world</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">hello_world</span> <span class="s">PRIVATE</span> <span class="s">world</span><span class="p">)</span>


<span class="nb">add_library</span><span class="p">(</span><span class="s">greeting</span><span class="p">)</span>
<span class="nb">target_sources</span><span class="p">(</span><span class="s">greeting</span>
  <span class="s">PUBLIC</span>
    <span class="s">greeting/greeting.hpp</span>
  <span class="s">PRIVATE</span>
    <span class="s">greeting/greeting.cpp</span>
  <span class="p">)</span>
<span class="nb">target_include_directories</span><span class="p">(</span><span class="s">greeting</span>
  <span class="s">PUBLIC</span>
    <span class="s">greeting</span>
  <span class="p">)</span>

<span class="c"># greeting depends on hello_world</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">greeting</span> <span class="s">PRIVATE</span> <span class="s">hello_world</span><span class="p">)</span>


<span class="nb">add_executable</span><span class="p">(</span><span class="s">example</span> <span class="s">main.cpp</span><span class="p">)</span>

<span class="c"># example depends on greeting</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">example</span> <span class="s">PRIVATE</span> <span class="s">greeting</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p><strong>This is a bad example</strong> although it might look more compact and possibly
neater at first sight.  It probably also works, at least on Linux,
probably not on macOS and Windows.  Can you point out the problems
that you see or anticipate with this structure?</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.14</span><span class="p">)</span>

<span class="hll"><span class="c"># note that the code below is a bad example only used for a discussion</span>
</span><span class="nb">project</span><span class="p">(</span><span class="s">bad-example</span> <span class="s">LANGUAGES</span> <span class="s">CXX</span><span class="p">)</span>

<span class="nb">add_definitions</span><span class="p">(</span><span class="s">-DMY_DEFINITION</span><span class="p">)</span>

<span class="nb">include_directories</span><span class="p">(</span><span class="s">world</span><span class="p">)</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="s">hello_world</span><span class="p">)</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="s">greeting</span><span class="p">)</span>

<span class="nb">link_libraries</span><span class="p">(</span>
  <span class="o">${</span><span class="nv">PROJECT_BINARY_DIR</span><span class="o">}</span><span class="s">/libgreeting.a</span>
  <span class="o">${</span><span class="nv">PROJECT_BINARY_DIR</span><span class="o">}</span><span class="s">/libhello_world.a</span>
  <span class="o">${</span><span class="nv">PROJECT_BINARY_DIR</span><span class="o">}</span><span class="s">/libworld.a</span>
  <span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span><span class="s">world</span>
  <span class="s">world/world.hpp</span>
  <span class="s">world/world.cpp</span>
  <span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span><span class="s">hello_world</span>
  <span class="s">hello_world/hello_world.hpp</span>
  <span class="s">hello_world/hello_world.cpp</span>
  <span class="p">)</span>
<span class="nb">add_dependencies</span><span class="p">(</span><span class="s">hello_world</span> <span class="s">world</span><span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span><span class="s">greeting</span>
  <span class="s">greeting/greeting.hpp</span>
  <span class="s">greeting/greeting.cpp</span>
  <span class="p">)</span>
<span class="nb">add_dependencies</span><span class="p">(</span><span class="s">greeting</span> <span class="s">hello_world</span><span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="s">example</span> <span class="s">main.cpp</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="admonition-solution solution important dropdown admonition">
<p class="admonition-title">Solution</p>
<p>Let us first note that the left solution is not perfect either. In a real
larger project we would probably want to define targets closer to the
sources.</p>
<p>Problems with the “bad” solution (perhaps you found other problems?):</p>
<ul class="simple">
<li><p>Compile definition <code class="docutils literal notranslate"><span class="pre">-DMY_DEFINITION</span></code> affects entire project.</p></li>
<li><p>Also the include directories and library link line settings affect the entire project.</p></li>
<li><p>The order of <code class="docutils literal notranslate"><span class="pre">link_libraries</span></code> matters.</p></li>
<li><p>Library names are hard-coded and it will not work on macOS or Windows where libraries
have different names.</p></li>
<li><p>Library names have been hard-coded to static libraries and it will be more difficult now
for us to switch between static or dynamic libraries.</p></li>
<li><p>If you rename a library you suddenly need to edit more places than in
the example using targets.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> became more brittle to order of lines.</p></li>
<li><p>It became more difficult to move sections to other <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> files.</p></li>
<li><p>Risk is higher to forget some definitions or library location or
include directories behind after moving sections away.</p></li>
<li><p>Settings in the target-based approach have more local scope. In the “bad” example
settings have global scope and risk having unintended side effects on other CMake code
in a larger project.</p></li>
</ul>
</div>
</div>
<div class="admonition-keypoints keypoints admonition">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>Using targets, you can achieve granular control over how artifacts are
built and how their dependencies are handled.</p></li>
<li><p>Compiler flags, definitions, source files, include folders, link libraries,
and linker options are <strong>properties</strong> of a target.</p></li>
<li><p>Avoid using variables to express dependencies between targets: use the
visibility levels <code class="docutils literal notranslate"><span class="pre">PRIVATE</span></code>, <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code>, <code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code> and let CMake
figure out the details.</p></li>
<li><p>Use <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/get_property.html"><span class="xref std std-term"><code class="docutils literal notranslate">get_property</code></span></a> to inquire and <a class="reference internal" href="https://cmake.org/cmake/help/latest/command/set_property.html"><span class="xref std std-term"><code class="docutils literal notranslate">set_property</code></span></a> to modify values of
properties.</p></li>
<li><p>To keep the complexity of the build system at a minimum, each folder in a
multi-folder project should have its own <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>.</p></li>
</ul>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../flags-definitions-debugging/" class="btn btn-neutral float-left" title="Compile flags, definitions, and debugging" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../environment/" class="btn btn-neutral float-right" title="Detecting your environment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, EuroCC National Competence Centre Sweden (this is derived work from the ENCCS workshop, see &#39;Credits&#39; about changes).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>