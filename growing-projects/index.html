<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Growing projects: pitfalls and recommendations &mdash; CMake Workshop  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" type="text/css" />
      <link rel="stylesheet" href="../_static/style.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/coderefinery.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Resources and books" href="../resources/" />
    <link rel="prev" title="Automated dependency handling with FetchContent" href="../fetch-content/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../" class="icon icon-home"> CMake Workshop
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Setting up your system</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../motivation/">Motivation and overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tour/">Brief tour to demonstrate concepts/capabilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hands-on workshop</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hello-cmake/">From sources to executables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flags-definitions-debugging/">Compile flags, definitions, and debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../targets/">Target-based build systems with CMake</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environment/">Detecting your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies/">Finding and using dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/">Creating and running tests with CTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fetch-content/">Automated dependency handling with FetchContent</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Growing projects: pitfalls and recommendations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#listing-sources-or-globbing-them">Listing sources or globbing them</a></li>
<li class="toctree-l2"><a class="reference internal" href="#options-and-flow-control">Options and flow control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#organizing-files-into-modules">Organizing files into modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variables-vs-targets">Variables vs. targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#functions-and-macros">Functions and macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="#where-to-list-sources-and-tests">Where to list sources and tests?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#order-and-side-effects">Order and side effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#where-to-keep-generated-files">Where to keep generated files</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../resources/">Resources and books</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits/">Credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">CMake Workshop</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home"></a> &raquo;</li>
      <li>Growing projects: pitfalls and recommendations</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/coderefinery/cmake-workshop/blob/main/content/growing-projects.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="growing-projects-pitfalls-and-recommendations">
<span id="growing-projects"></span><h1>Growing projects: pitfalls and recommendations<a class="headerlink" href="#growing-projects-pitfalls-and-recommendations" title="Permalink to this headline"></a></h1>
<div class="admonition-objectives objectives admonition">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Learn what tools exist to structure projects as they grow.</p></li>
<li><p>Discuss the value of localizing scope and avoiding side effects.</p></li>
<li><p>Recognize more maintainable and less maintainable patterns.</p></li>
</ul>
</div>
<p>As projects grow, things get more complicated: more possibilities, more corner
cases, more options to the user, and more developers who are contributing and
may not oversee the entire CMake structure. In this episode we will mention a
couple of tools to bring some structure and flow-control into larger projects.</p>
<div class="section" id="listing-sources-or-globbing-them">
<h2>Listing sources or globbing them<a class="headerlink" href="#listing-sources-or-globbing-them" title="Permalink to this headline"></a></h2>
<p>In all our examples we have listed all sources when defining targets.</p>
<p>In CMake you can glob patters (e.g. all files that end with <code class="docutils literal notranslate"><span class="pre">*.cpp</span></code>) without
listing them explicitly. This is tempting but do not do this. The reason is
that CMake cannot track dependency changes when you add files after you have
configured.</p>
<p>Listing files explicitly also allows to “grep” for them in the CMake code to
see where a modification is likely needed. This can help colleagues in our
projects who are not familiar with CMake to find out where to change things.</p>
</div>
<div class="section" id="options-and-flow-control">
<h2>Options and flow control<a class="headerlink" href="#options-and-flow-control" title="Permalink to this headline"></a></h2>
<p>You may want to give the user the possibility to decide whether they want to
enable an option or not.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># by default this one will be ON</span>
<span class="nb">option</span><span class="p">(</span><span class="s">ENABLE_MPI</span> <span class="s2">&quot;Configure for MPI parallelization&quot;</span> <span class="s">ON</span><span class="p">)</span>

<span class="nb">if</span><span class="p">(</span><span class="s">ENABLE_MPI</span><span class="p">)</span>
  <span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span> <span class="s">REQUIRED</span> <span class="s">COMPONENTS</span> <span class="s">Fortran</span><span class="p">)</span>
<span class="nb">else</span><span class="p">()</span>
  <span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span> <span class="s2">&quot;no problem, building without MPI&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>Now the user can decide:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cmake -S. -Bbuild -DENABLE_MPI<span class="o">=</span>OFF
</pre></div>
</div>
</div>
<div class="section" id="organizing-files-into-modules">
<h2>Organizing files into modules<a class="headerlink" href="#organizing-files-into-modules" title="Permalink to this headline"></a></h2>
<p>Modules are collections of functions and macros and are either CMake- or user-defined.
CMake comes with a rich ecosystem of modules and you will probably write a few
of your own to encapulate frequently used functions or macros in your CMake
scripts.</p>
<p>We have seen this module earlier today:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">include</span><span class="p">(</span><span class="s">CMakePrintHelpers</span><span class="p">)</span>
</pre></div>
</div>
<p>You can collect related CMake-code into a file called <code class="docutils literal notranslate"><span class="pre">my_lengthy_code.cmake</span></code>
and then include it in another CMake code:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">include</span><span class="p">(</span><span class="s">my_lengthy_code</span><span class="p">)</span>
</pre></div>
</div>
<p>This can help organizing projects that are growing out of hand and separate
concerns.</p>
</div>
<div class="section" id="variables-vs-targets">
<h2>Variables vs. targets<a class="headerlink" href="#variables-vs-targets" title="Permalink to this headline"></a></h2>
<p>In <a class="reference internal" href="../targets/#targets"><span class="std std-ref">Target-based build systems with CMake</span></a> we have motivated why targets are preferable over variables.</p>
<p>When you portion your project into modules, then variable declaration impose an
order and the risk is high that somebody will not know about the implicit order
and reorder modules one day and the behavior will change.</p>
<p>Try to minimize the use of user-defined variables. They can point to a
sub-optimal solution and a better, more state-less, declarative, solution may
exist.</p>
</div>
<div class="section" id="functions-and-macros">
<h2>Functions and macros<a class="headerlink" href="#functions-and-macros" title="Permalink to this headline"></a></h2>
<p><strong>Functions</strong> and <strong>macros</strong> are build on top of the basic built-in commands
and are either CMake- or user-defined.  These prove useful to avoid repetition
in your CMake scripts.  The difference between a function and a macro is their
<em>scope</em>:</p>
<ol class="arabic simple">
<li><p>Functions have their own scope: variables defined inside a function are not
propagated back to the caller.</p></li>
<li><p>Macros do not have their own scope: variables from the parent scope can be
modified and new variables in the parent scope can be set.</p></li>
</ol>
<p>Prefer functions over macros to minimize side-effects.</p>
</div>
<div class="section" id="where-to-list-sources-and-tests">
<h2>Where to list sources and tests?<a class="headerlink" href="#where-to-list-sources-and-tests" title="Permalink to this headline"></a></h2>
<p>Some projects collect all sources in one file, all tests in another
file, and carry them across in variables:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>project/
├── CMakeLists.txt
├── cmake
|   ├── sources.cmake
|   ├── tests.cmake
|   └── definitions.cmake
├── external
└── src
    ├── evolution
    ├── initial
    ├── io
    └── parser
</pre></div>
</div>
<p>Do this instead (sources, definitions, and tests defined in the “closest” <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>project/
├── CMakeLists.txt
├── external
│   ├── CMakeLists.txt
└── src
    ├── CMakeLists.txt
    ├── evolution
    │   ├── CMakeLists.txt
    ├── initial
    │   ├── CMakeLists.txt
    ├── io
    │   ├── CMakeLists.txt
    └── parser
        └── CMakeLists.txt
</pre></div>
</div>
<p>The reason is that this will minimize side-effects, ordering effects, and
simplify maintenance for those who want to add or rename source files: they can
do it in one place, close to where they are coding.</p>
</div>
<div class="section" id="order-and-side-effects">
<h2>Order and side effects<a class="headerlink" href="#order-and-side-effects" title="Permalink to this headline"></a></h2>
<p>When portioning your project into modules, design them in a way so that order
does not matter (much).</p>
<p>This is easier with functions than with macros and easier with targets than
with variables.</p>
<p>Avoid variables with parent or global scope. Encapsulate and prefer separation
of concerns.</p>
</div>
<div class="section" id="where-to-keep-generated-files">
<h2>Where to keep generated files<a class="headerlink" href="#where-to-keep-generated-files" title="Permalink to this headline"></a></h2>
<p>CMake allows us to generate files at configure- or build-time.  When generating
files, always generate into the build folder, never outside the build folder.</p>
<p>The reason is that you always want to maintain the possibility to configure
different builds with the same source without having to copy the entire project
to a different place.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../fetch-content/" class="btn btn-neutral float-left" title="Automated dependency handling with FetchContent" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../resources/" class="btn btn-neutral float-right" title="Resources and books" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, EuroCC National Competence Centre Sweden (this is derived work from the ENCCS workshop, see &#39;Credits&#39; about changes).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>